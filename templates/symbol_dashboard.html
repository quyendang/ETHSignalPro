<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ symbol }} Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-sub: #64748b;
      --accent: #2563eb;
      --green: #22c55e;
      --red: #ef4444;
      --muted: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .header-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .badge-symbol {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.08);
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-state {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .state-buy  { background-color: var(--green); color: #ffffff; }
    .state-sell { background-color: var(--red);   color: #ffffff; }
    .state-hold { background-color: #6b7280;     color: #ffffff; }

    .header-sub {
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
    }

    .card-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .card-main {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .card-sub {
      font-size: 0.82rem;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .change-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #ffffff;
    }

    .change-pos { background-color: var(--green); }
    .change-neg { background-color: var(--red); }

    .panel {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 16px 20px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .panel-title {
      font-size: 0.96rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title span.sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      font-weight: 400;
    }

    canvas { max-width: 100%; }

    .zone-legend {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .legend-box {
      width: 14px;
      height: 8px;
      border-radius: 999px;
    }

    .legend-buy  { background: rgba(34, 197, 94, 0.12); }
    .legend-sell { background: rgba(239, 68, 68, 0.12); }

    .sub-btn {
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 999px;
    }

    @media (max-width: 640px) {
      .header { align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <header class="header">
      <div>
        <div class="header-title">
          {{ symbol }} Dashboard
          <span class="badge-symbol">
            <span style="width:8px;height:8px;border-radius:999px;background:#22c55e;"></span>
            Spot Tracker
          </span>
          <span id="lastStateBadge" class="badge-state state-hold">HOLD</span>
        </div>
        <div class="header-sub">
          Auto-tracking Price, RSI, zones & BUY/SELL signals (4H data)
          <br />
          <small>
            Server tracker:
            <strong>{{ tracker_action }}</strong>
            {% if tracker_reason %}
              – {{ tracker_reason }}
            {% endif %}
          </small>
        </div>
      </div>

      <div>
        {% if is_subscribed %}
        <form method="post" action="/bots/unsubscribe">
          <input type="hidden" name="symbol" value="{{ symbol }}">
          <button type="submit" class="sub-btn state-sell">UNSUBSCRIBE</button>
        </form>
        {% else %}
        <form method="post" action="/bots/subscribe">
          <input type="hidden" name="symbol" value="{{ symbol }}">
          <button type="submit" class="sub-btn state-buy">SUBSCRIBE</button>
        </form>
        {% endif %}
      </div>
    </header>

    <!-- SUMMARY CARDS -->
    <section class="cards">
      <div class="card">
        <div class="card-label">Current Price</div>
        <div class="card-main">
          <span>${{ "%.2f"|format(last_price) if last_price is not none else "…" }}</span>
          {% if change_24h is not none %}
          {% set change_cls = "change-pos" if change_24h >= 0 else "change-neg" %}
          <span class="change-badge {{ change_cls }}">
            {{ "%+.2f"|format(change_24h) }}%
          </span>
          {% endif %}
        </div>
        <div class="card-sub">Last candle close (4H)</div>
      </div>

      <div class="card">
        <div class="card-label">RSI H4</div>
        <div class="card-main">
          <span>{{ "%.2f"|format(last_rsi) if last_rsi is not none else "…" }}</span>
        </div>
        <div class="card-sub">Momentum oscillator (0–100)</div>
      </div>

      <div class="card">
        <div class="card-label">Buy Zone</div>
        <div class="card-main">
          {% if buy_low is not none and buy_high is not none %}
          <span>${{ "%.0f"|format(buy_low) }} – {{ "%.0f"|format(buy_high) }}</span>
          {% else %}
          <span>Auto-calculating…</span>
          {% endif %}
        </div>
        <div class="card-sub">Only BUY signals inside this zone</div>
      </div>

      <div class="card">
        <div class="card-label">Sell Zone</div>
        <div class="card-main">
          {% if sell_low is not none and sell_high is not none %}
          <span>${{ "%.0f"|format(sell_low) }} – {{ "%.0f"|format(sell_high) }}</span>
          {% else %}
          <span>Auto-calculating…</span>
          {% endif %}
        </div>
        <div class="card-sub">Only SELL signals inside this zone</div>
      </div>
    </section>

    <!-- MAIN CHART -->
    <section class="panel">
      <div class="panel-title">
        <div>
          Giá {{ symbol }} (Price + RSI + Buy/Sell signals)
          <span class="sub">4H candles</span>
        </div>
        <div class="zone-legend">
          <span class="legend-box legend-buy"></span> Buy zone
          <span class="legend-box legend-sell"></span> Sell zone
        </div>
      </div>
      <canvas id="priceRsiChart" height="260"></canvas>
    </section>

    <!-- BACKTEST SECTION -->
    <section class="panel" style="margin-top: 20px;">
      <div class="panel-title">
        <div>Backtest Analysis</div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
        <div>
          <label style="display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px;">Start Date</label>
          <input type="datetime-local" id="backtestStartDate" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;" />
        </div>
        <div>
          <label style="display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px;">End Date</label>
          <input type="datetime-local" id="backtestEndDate" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;" />
        </div>
        <div>
          <label style="display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px;">Lookback Candles</label>
          <input type="number" id="backtestLookback" value="60" min="20" max="200" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;" />
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-bottom: 12px;">
        <button id="btnHistoryBacktest" style="flex: 1; padding: 10px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
          HIS BACKTEST
        </button>
        <button id="btnRealtimeBacktest" style="flex: 1; padding: 10px 16px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
          REAL BACKTEST
        </button>
      </div>
      
      <div id="backtestResults" style="display: none; padding: 12px; background: rgba(37, 99, 235, 0.05); border-radius: 8px; margin-top: 12px;">
        <div style="font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px;">
          <strong>Results:</strong> <span id="backtestStats"></span>
        </div>
        <div id="backtestError" style="color: var(--red); font-size: 0.85rem; display: none;"></div>
      </div>
    </section>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script>
    // ==== 1. Dữ liệu từ backend ====
    const rows = {{ rows_json | tojson }};
    const symbol = "{{ symbol }}";

    const labels    = rows.map(r => r.time_str);
    const prices    = rows.map(r => r.price);
    const rsiValues = rows.map(r => r.rsi_h4);

    const emaFast   = rows.map(r => r.ema_fast);
    const emaSlow   = rows.map(r => r.ema_slow);
    const bbUpper   = rows.map(r => r.bb_upper);
    const bbLower   = rows.map(r => r.bb_lower);
    const stochK    = rows.map(r => r.stoch_k);
    const wrValues  = rows.map(r => r.wr);

    const buyLow  = {{ buy_low  if buy_low  is not none else 'null' }};
    const buyHigh = {{ buy_high if buy_high is not none else 'null' }};
    const sellLow = {{ sell_low if sell_low is not none else 'null' }};
    const sellHigh= {{ sell_high if sell_high is not none else 'null' }};

    // ==== 2. Plugin vẽ BUY/SELL ZONES ====
    const priceZonesPlugin = {
      id: 'priceZones',
      beforeDraw(chart, args, pluginOptions) {
        if (chart.canvas.id !== "priceRsiChart") return;
        if (buyLow == null || buyHigh == null || sellLow == null || sellHigh == null) return;

        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const { left, right } = chartArea;
        const yScale = scales['y'];

        if (!yScale) return;

        ctx.save();

        // BUY ZONE
        const yBuyLow  = yScale.getPixelForValue(buyLow);
        const yBuyHigh = yScale.getPixelForValue(buyHigh);
        const buyTop    = Math.min(yBuyHigh, yBuyLow);
        const buyBottom = Math.max(yBuyHigh, yBuyLow);

        ctx.fillStyle = "rgba(34, 197, 94, 0.12)";
        ctx.fillRect(left, buyTop, right - left, buyBottom - buyTop);

        // SELL ZONE
        const ySellLow  = yScale.getPixelForValue(sellLow);
        const ySellHigh = yScale.getPixelForValue(sellHigh);
        const sellTop    = Math.min(ySellHigh, ySellLow);
        const sellBottom = Math.max(ySellHigh, ySellLow);

        ctx.fillStyle = "rgba(239, 68, 68, 0.12)";
        ctx.fillRect(left, sellTop, right - left, sellBottom - sellTop);

        ctx.restore();
      }
    };

    // ==== 3. Tính BUY / SELL signals & trạng thái cuối (client-side) ====
    function computeSignals(
      prices, rsiArr, bbU, bbL, emaF, emaS, stochArr, wrArr,
      buyLow, buyHigh, sellLow, sellHigh
    ) {
      const n = prices.length;
      const buySignals  = new Array(n).fill(null);
      const sellSignals = new Array(n).fill(null);
      let lastState = "HOLD";

      for (let i = 0; i < n; i++) {
        const price = prices[i];
        const rsi   = rsiArr[i];
        const bu    = bbU[i];
        const bl    = bbL[i];
        const ef    = emaF[i];
        const es    = emaS[i];
        const stoch = stochArr[i];
        const wr    = wrArr[i];

        // BUY conditions
        const isRsiOversold   = rsi   != null && rsi < 40;
        const isBbTouchLow    = bl    != null && price <= bl;
        const isStochLow      = stoch != null && stoch < 20;
        const isWrLow         = wr    != null && wr   < -80;
        const trendUp         = ef    != null && es   != null && ef >= es;

        const condBuy1 = isRsiOversold && isBbTouchLow;
        const condBuy2 = isStochLow && isWrLow && trendUp;

        // SELL conditions
        const isRsiOverbought = rsi   != null && rsi > 60;
        const isBbTouchHigh   = bu    != null && price >= bu;
        const isStochHigh     = stoch != null && stoch > 80;
        const isWrHigh        = wr    != null && wr   > -20;
        const trendDown       = ef    != null && es   != null && ef <= es;

        const condSell1 = isRsiOverbought && isBbTouchHigh;
        const condSell2 = isStochHigh && isWrHigh && trendDown;

        // giới hạn theo zone
        let inBuyZone = true;
        if (buyLow !== null && buyHigh !== null) {
          inBuyZone = price >= buyLow && price <= buyHigh;
        }
        let inSellZone = true;
        if (sellLow !== null && sellHigh !== null) {
          inSellZone = price >= sellLow && price <= sellHigh;
        }

        const isBuySignal  = (condBuy1  || condBuy2)  && inBuyZone;
        const isSellSignal = (condSell1 || condSell2) && inSellZone;

        if (isBuySignal && !isSellSignal) {
          buySignals[i] = price;
          lastState = "BUY";
        } else if (isSellSignal && !isBuySignal) {
          sellSignals[i] = price;
          lastState = "SELL";
        }
      }

      return { buySignals, sellSignals, lastState };
    }

    const { buySignals, sellSignals, lastState } = computeSignals(
      prices, rsiValues, bbUpper, bbLower, emaFast, emaSlow, stochK, wrValues,
      buyLow, buyHigh, sellLow, sellHigh
    );

    // ==== 4. Badge trạng thái cuối ====
    const stateEl = document.getElementById("lastStateBadge");
    if (stateEl) {
      stateEl.textContent = lastState;
      stateEl.classList.remove("state-buy", "state-sell", "state-hold");
      if (lastState === "BUY")   stateEl.classList.add("state-buy");
      else if (lastState === "SELL") stateEl.classList.add("state-sell");
      else stateEl.classList.add("state-hold");
    }

    // ==== 5. Build points cho scatter BUY/SELL ====
    function buildSignalPoints(signals) {
      const pts = [];
      for (let i = 0; i < signals.length; i++) {
        if (signals[i] !== null && signals[i] !== undefined) {
          pts.push({ 
            x: labels[i], 
            y: signals[i],
            price: signals[i]  // Lưu giá để plugin hiển thị
          });
        }
      }
      return pts;
    }

    const buyPoints  = buildSignalPoints(buySignals);
    const sellPoints = buildSignalPoints(sellSignals);

    Chart.register(priceZonesPlugin);

    // ==== 6. Plugin hiển thị labels giá tại các điểm buy/sell ====
    const priceLabelPlugin = {
      id: 'priceLabel',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        
        const yScale = scales['y'];
        if (!yScale) return;
        
        ctx.save();
        ctx.font = 'bold 11px system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // Helper function để vẽ rounded rectangle (fallback nếu không có roundRect)
        const drawRoundedRect = (x, y, width, height, radius) => {
          ctx.beginPath();
          ctx.moveTo(x + radius, y);
          ctx.lineTo(x + width - radius, y);
          ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
          ctx.lineTo(x + width, y + height - radius);
          ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
          ctx.lineTo(x + radius, y + height);
          ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
          ctx.lineTo(x, y + radius);
          ctx.quadraticCurveTo(x, y, x + radius, y);
          ctx.closePath();
        };
        
        // Vẽ labels cho tất cả datasets
        chart.data.datasets.forEach((dataset, datasetIndex) => {
          // Chỉ vẽ labels cho scatter datasets (buy/sell signals)
          if (dataset.type !== 'scatter' || !dataset.data || dataset.data.length === 0) {
            return;
          }
          
          const meta = chart.getDatasetMeta(datasetIndex);
          const isBuy = dataset.label && (dataset.label.includes('BUY') || dataset.label.includes('Buy'));
          const isSell = dataset.label && (dataset.label.includes('SELL') || dataset.label.includes('Sell'));
          
          if (!isBuy && !isSell) return;
          
          meta.data.forEach((point, index) => {
            if (!point || point.skip) return;
            
            const x = point.x;
            const y = point.y;
            
            // Lấy giá từ data point (có thể là object với property price hoặc là giá trị số)
            let price;
            const dataPoint = dataset.data[index];
            if (typeof dataPoint === 'object' && dataPoint !== null) {
              price = dataPoint.price || dataPoint.y;
            } else {
              price = dataPoint;
            }
            
            if (price === null || price === undefined) return;
            
            // Format giá
            const labelText = '$' + parseFloat(price).toFixed(2);
            const textMetrics = ctx.measureText(labelText);
            const textWidth = textMetrics.width;
            const textHeight = 14;
            const padding = 4;
            
            // Vị trí label (phía trên điểm cho BUY, phía dưới cho SELL)
            const labelY = isBuy ? y - 20 : y + 20;
            
            // Vẽ background rounded rectangle
            ctx.fillStyle = isBuy ? 'rgba(34, 197, 94, 0.9)' : 'rgba(239, 68, 68, 0.9)';
            const rectX = x - textWidth / 2 - padding;
            const rectY = labelY - textHeight / 2 - padding;
            const rectWidth = textWidth + padding * 2;
            const rectHeight = textHeight + padding * 2;
            
            // Sử dụng roundRect nếu có, nếu không dùng fallback
            if (ctx.roundRect) {
              ctx.beginPath();
              ctx.roundRect(rectX, rectY, rectWidth, rectHeight, 4);
              ctx.fill();
            } else {
              drawRoundedRect(rectX, rectY, rectWidth, rectHeight, 4);
              ctx.fill();
            }
            
            // Vẽ text
            ctx.fillStyle = '#ffffff';
            ctx.fillText(labelText, x, labelY);
          });
        });
        
        ctx.restore();
      }
    };
    
    Chart.register(priceLabelPlugin);

    // ==== 6. Vẽ chart Price + RSI + BUY/SELL ====
    const ctxPriceRsi = document.getElementById("priceRsiChart").getContext("2d");

    let priceRsiChart = new Chart(ctxPriceRsi, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: symbol + " Price",
            data: prices,
            borderColor: "rgba(37, 99, 235, 1)",
            backgroundColor: "rgba(37, 99, 235, 0.05)",
            yAxisID: "y",
            tension: 0.2,
            pointRadius: 0
          },
          {
            label: "RSI H4",
            data: rsiValues,
            borderColor: "rgba(16, 185, 129, 1)",
            backgroundColor: "rgba(16, 185, 129, 0.05)",
            yAxisID: "y1",
            tension: 0.2,
            pointRadius: 0
          },
          {
            type: "scatter",
            label: "BUY Signal",
            data: buyPoints,
            yAxisID: "y",
            borderColor: "rgba(22, 163, 74, 1)",
            backgroundColor: "rgba(22, 163, 74, 1)",
            pointStyle: "triangle",
            pointRadius: 6,
            pointHoverRadius: 7
          },
          {
            type: "scatter",
            label: "SELL Signal",
            data: sellPoints,
            yAxisID: "y",
            borderColor: "rgba(239, 68, 68, 1)",
            backgroundColor: "rgba(239, 68, 68, 1)",
            pointStyle: "triangle",
            pointRotation: 180,
            pointRadius: 6,
            pointHoverRadius: 7
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          y: {
            type: "linear",
            position: "left",
            title: { display: true, text: "Price" },
            grid: { drawOnChartArea: true }
          },
          y1: {
            type: "linear",
            position: "right",
            title: { display: true, text: "RSI H4" },
            min: 0,
            max: 100,
            grid: { drawOnChartArea: false }
          },
          x: {
            ticks: { maxRotation: 60, minRotation: 45 }
          }
        }
      }
    });

    // ==== 7. BACKTEST FUNCTIONALITY ====
    // Set default dates (30 days ago to today)
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    const formatDateForInput = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    document.getElementById("backtestStartDate").value = formatDateForInput(thirtyDaysAgo);
    document.getElementById("backtestEndDate").value = formatDateForInput(now);
    
    // Backtest datasets (will be added to chart)
    let backtestBuyDataset = null;
    let backtestSellDataset = null;
    
    async function runBacktest(mode) {
      const startDate = document.getElementById("backtestStartDate").value;
      const endDate = document.getElementById("backtestEndDate").value;
      const lookback = parseInt(document.getElementById("backtestLookback").value) || 60;
      
      if (!startDate || !endDate) {
        alert("Please select both start and end dates");
        return;
      }
      
      // Convert to ISO format for API
      const startISO = new Date(startDate).toISOString();
      const endISO = new Date(endDate).toISOString();
      
      const resultsDiv = document.getElementById("backtestResults");
      const statsDiv = document.getElementById("backtestStats");
      const errorDiv = document.getElementById("backtestError");
      
      resultsDiv.style.display = "block";
      errorDiv.style.display = "none";
      statsDiv.textContent = "Running backtest...";
      
      try {
        const formData = new FormData();
        formData.append("symbol", symbol);
        formData.append("start_date", startISO);
        formData.append("end_date", endISO);
        formData.append("interval", "4h");
        formData.append("lookback", lookback.toString());
        formData.append("mode", mode);
        
        const response = await fetch("/bots/backtest", {
          method: "POST",
          body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || "Backtest failed");
        }
        
        // Display stats
        statsDiv.textContent = `Total: ${data.total_candles} candles | BUY: ${data.buy_count} | SELL: ${data.sell_count}`;
        
        // Remove old backtest datasets
        if (backtestBuyDataset !== null) {
          priceRsiChart.data.datasets.splice(priceRsiChart.data.datasets.indexOf(backtestBuyDataset), 1);
        }
        if (backtestSellDataset !== null) {
          priceRsiChart.data.datasets.splice(priceRsiChart.data.datasets.indexOf(backtestSellDataset), 1);
        }
        
        // Map backtest signals to chart labels
        // Find closest label index for each signal timestamp
        const findClosestLabelIndex = (signalTime) => {
          const signalDate = new Date(signalTime);
          let closestIdx = 0;
          let minDiff = Infinity;
          
          for (let i = 0; i < labels.length; i++) {
            const labelDate = new Date(labels[i]);
            const diff = Math.abs(signalDate - labelDate);
            if (diff < minDiff) {
              minDiff = diff;
              closestIdx = i;
            }
          }
          return closestIdx;
        };
        
        // Add backtest signals to chart (map to closest label)
        // Lưu cả giá để hiển thị label
        const buySignals = data.signals
          .filter(s => s.action === "BUY")
          .map(s => {
            const idx = findClosestLabelIndex(s.time);
            return {
              x: labels[idx] || s.time,
              y: s.price,
              price: s.price  // Lưu giá để plugin hiển thị
            };
          });
        
        const sellSignals = data.signals
          .filter(s => s.action === "SELL")
          .map(s => {
            const idx = findClosestLabelIndex(s.time);
            return {
              x: labels[idx] || s.time,
              y: s.price,
              price: s.price  // Lưu giá để plugin hiển thị
            };
          });
        
        // Add BUY signals dataset
        backtestBuyDataset = {
          type: "scatter",
          label: "Backtest BUY",
          data: buySignals,
          yAxisID: "y",
          borderColor: "rgba(34, 197, 94, 0.8)",
          backgroundColor: "rgba(34, 197, 94, 0.6)",
          pointStyle: "circle",
          pointRadius: 8,
          pointHoverRadius: 10,
          borderWidth: 2
        };
        
        // Add SELL signals dataset
        backtestSellDataset = {
          type: "scatter",
          label: "Backtest SELL",
          data: sellSignals,
          yAxisID: "y",
          borderColor: "rgba(239, 68, 68, 0.8)",
          backgroundColor: "rgba(239, 68, 68, 0.6)",
          pointStyle: "circle",
          pointRadius: 8,
          pointHoverRadius: 10,
          borderWidth: 2
        };
        
        priceRsiChart.data.datasets.push(backtestBuyDataset);
        priceRsiChart.data.datasets.push(backtestSellDataset);
        
        // Update chart
        priceRsiChart.update();
        
      } catch (error) {
        errorDiv.style.display = "block";
        errorDiv.textContent = `Error: ${error.message}`;
        statsDiv.textContent = "";
      }
    }
    
    // Event listeners
    document.getElementById("btnHistoryBacktest").addEventListener("click", () => {
      runBacktest("history");
    });
    
    document.getElementById("btnRealtimeBacktest").addEventListener("click", () => {
      runBacktest("realtime");
    });
  </script>
</body>
</html>
